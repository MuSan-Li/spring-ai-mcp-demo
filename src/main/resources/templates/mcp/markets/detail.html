<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>市场详情</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: calc(100vh - 56px);
            background-color: #f8f9fa;
        }
        .main-content {
            min-height: calc(100vh - 56px);
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-gear-fill"></i> MCP管理系统
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/mcp/tools">工具管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/mcp/markets">市场管理</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- 左侧菜单 -->
            <div class="col-md-2 sidebar p-3">
                <ul class="nav nav-pills flex-column">
                    <li class="nav-item mb-2">
                        <a class="nav-link" href="/mcp/tools">
                            <i class="bi bi-tools"></i> MCP工具管理
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link active" href="/mcp/markets">
                            <i class="bi bi-shop"></i> MCP市场管理
                        </a>
                    </li>
                </ul>
            </div>

            <!-- 主内容区 -->
            <div class="col-md-10 main-content p-4">
                <!-- 消息提示 -->
                <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle"></i> <span th:text="${success}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle"></i> <span th:text="${error}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-4" data-market-id th:attr="data-market-id=${market.id}">
                    <h2>
                        <i class="bi bi-shop"></i> 市场详情：<span th:text="${market.name}"></span>
                    </h2>
                    <div>
                        <form th:action="@{/mcp/markets/refresh/{id}(id=${market.id})}" method="post" style="display: inline;">
                            <button type="submit" class="btn btn-info">
                                <i class="bi bi-arrow-clockwise"></i> 刷新工具列表
                            </button>
                        </form>
                        <a href="/mcp/markets" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> 返回列表
                        </a>
                    </div>
                </div>

                <!-- 市场基本信息 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">基本信息</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>市场名称：</strong><span th:text="${market.name}"></span></p>
                                <p><strong>市场URL：</strong><a th:href="${market.url}" target="_blank" th:text="${market.url}"></a></p>
                                <p><strong>状态：</strong>
                                    <span class="badge" th:classappend="${market.status == 'ENABLED'} ? 'bg-success' : 'bg-secondary'" th:text="${market.status == 'ENABLED'} ? '启用' : '禁用'"></span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>描述：</strong><span th:text="${market.description != null ? market.description : '-'}"></span></p>
                                <p><strong>创建时间：</strong><span th:text="${#temporals.format(market.createTime, 'yyyy-MM-dd HH:mm:ss')}"></span></p>
                                <p><strong>更新时间：</strong><span th:text="${#temporals.format(market.updateTime, 'yyyy-MM-dd HH:mm:ss')}"></span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 市场工具列表 -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">可用工具列表</h5>
                        <button type="button" class="btn btn-sm btn-primary" onclick="batchLoad()">
                            <i class="bi bi-download"></i> 批量加载
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th width="50">
                                            <input type="checkbox" id="selectAllTools" onchange="toggleSelectAllTools()">
                                        </th>
                                        <th>工具名称</th>
                                        <th>版本</th>
                                        <th>描述</th>
                                        <th>加载状态</th>
                                        <th width="150">操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:if="${tools == null || tools.isEmpty()}">
                                        <td colspan="6" class="text-center text-muted">
                                            暂无工具，请点击"刷新工具列表"按钮从市场获取工具
                                        </td>
                                    </tr>
                                    <tr th:each="tool : ${tools}">
                                        <td>
                                            <input type="checkbox" class="tool-checkbox" th:value="${tool.id}" th:disabled="${tool.isLoaded}">
                                        </td>
                                        <td th:text="${tool.toolName}"></td>
                                        <td th:text="${tool.toolVersion != null ? tool.toolVersion : '-'}"></td>
                                        <td th:text="${tool.toolDescription != null ? tool.toolDescription : '-'}"></td>
                                        <td>
                                            <span class="badge" th:classappend="${tool.isLoaded} ? 'bg-success' : 'bg-secondary'" th:text="${tool.isLoaded} ? '已加载' : '未加载'"></span>
                                        </td>
                                        <td>
                                            <form th:if="${!tool.isLoaded}" th:action="@{/mcp/markets/tools/load/{toolId}(toolId=${tool.id}, marketId=${market.id})}" method="post" style="display: inline;">
                                                <button type="submit" class="btn btn-sm btn-primary">
                                                    <i class="bi bi-download"></i> 加载
                                                </button>
                                            </form>
                                            <span th:if="${tool.isLoaded}" class="text-muted">已加载</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script>
        function toggleSelectAllTools() {
            const selectAll = document.getElementById('selectAllTools');
            const checkboxes = document.querySelectorAll('.tool-checkbox:not([disabled])');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
        }

        function batchLoad() {
            const checked = Array.from(document.querySelectorAll('.tool-checkbox:checked')).map(cb => cb.value);
            if (checked.length === 0) {
                alert('请选择要加载的工具');
                return;
            }
            if (confirm('确定要加载选中的 ' + checked.length + ' 个工具吗？')) {
                // 从 URL 中获取 marketId，或者从页面中获取
                const marketId = getMarketId();
                if (!marketId) {
                    alert('无法获取市场ID，请刷新页面重试');
                    return;
                }
                
                // 创建表单并提交所有选中的工具ID（用逗号分隔）
                const form = document.createElement('form');
                form.method = 'post';
                form.action = '/mcp/markets/tools/batch-load';
                
                // 添加市场ID
                const marketIdInput = document.createElement('input');
                marketIdInput.type = 'hidden';
                marketIdInput.name = 'marketId';
                marketIdInput.value = marketId;
                form.appendChild(marketIdInput);
                
                // 添加所有选中的工具ID（用逗号分隔）
                const toolIdsInput = document.createElement('input');
                toolIdsInput.type = 'hidden';
                toolIdsInput.name = 'toolIds';
                toolIdsInput.value = checked.join(',');
                form.appendChild(toolIdsInput);
                
                document.body.appendChild(form);
                form.submit();
            }
        }
        
        function getMarketId() {
            // 方法1: 从 Thymeleaf 变量获取
            const marketIdElement = document.querySelector('[data-market-id]');
            if (marketIdElement) {
                return marketIdElement.getAttribute('data-market-id');
            }
            
            // 方法2: 从 URL 中提取
            const urlMatch = window.location.pathname.match(/\/mcp\/markets\/(\d+)/);
            if (urlMatch && urlMatch[1]) {
                return urlMatch[1];
            }
            
            // 方法3: 从隐藏的 input 中获取（如果有）
            const hiddenInput = document.querySelector('input[name="marketId"]');
            if (hiddenInput) {
                return hiddenInput.value;
            }
            
            return null;
        }
    </script>
</body>
</html>
